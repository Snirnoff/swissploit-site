// assets/blog-post.js
(function () {
  const posts = window.SWISSPLOIT_BLOG_POSTS || [];
  const params = new URLSearchParams(location.search);
  const id = params.get("id");

  // ✅ Deine IDs aus blog-post.html
  const titleEl = document.getElementById("postTitle");
  const subtitleEl = document.getElementById("postSubtitle");
  const metaEl = document.getElementById("postMeta");
  const contentEl = document.getElementById("postContent");

  const backEl = document.querySelector(".post-back"); // existiert bereits im HTML
  const langBtns = document.querySelectorAll(".lang-btn"); // falls du später addest

  const UI = {
    de: { back: "← Zurück", notFoundTitle: "Artikel nicht gefunden", notFoundBody: "Der Link ist ungültig oder der Beitrag existiert nicht.", watch: "▶ Video ansehen" },
    en: { back: "← Back", notFoundTitle: "Post not found", notFoundBody: "The link is invalid or the post doesn’t exist.", watch: "▶ Watch video" }
  };

  // Sprache wie im Blog-Listing
  let currentLang = localStorage.getItem("swissploit-blog-lang") || "de";
  const post = posts.find(p => p.id === id);

  function esc(s) {
    return String(s || "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  // Unterstützt: watch?v=, youtu.be/, youtube.com/shorts/
  function youtubeEmbed(url) {
    try {
      const u = new URL(url);

      const v = u.searchParams.get("v");
      if (u.hostname.includes("youtube.com") && v) {
        return `https://www.youtube.com/embed/${v}`;
      }

      if (u.hostname.includes("youtu.be")) {
        const vid = u.pathname.replace("/", "").trim();
        if (vid) return `https://www.youtube.com/embed/${vid}`;
      }

      if (u.hostname.includes("youtube.com") && u.pathname.startsWith("/shorts/")) {
        const vid = u.pathname.split("/shorts/")[1]?.split(/[?&#/]/)[0];
        if (vid) return `https://www.youtube.com/embed/${vid}`;
      }
    } catch (e) {}
    return null;
  }

  function getTxt() {
    return (post?.i18n?.[currentLang]) || (post?.i18n?.de) || {};
  }

  function setBackText() {
    const ui = UI[currentLang] || UI.de;
    if (backEl) backEl.textContent = ui.back;
  }

  function renderNotFound() {
    const ui = UI[currentLang] || UI.de;
    document.title = `Swissploit – Blog`;

    if (titleEl) titleEl.textContent = ui.notFoundTitle;
    if (subtitleEl) subtitleEl.textContent = "";
    if (metaEl) metaEl.innerHTML = "";
    if (contentEl) {
      contentEl.innerHTML = `
        <p>${esc(ui.notFoundBody)}</p>
        <p><a class="btn small" href="blog.html" data-transition>${esc(currentLang === "de" ? "Zur Übersicht" : "Back to overview")}</a></p>
      `;
    }
  }

  function render() {
    setBackText();

    if (!post) return renderNotFound();

    const txt = getTxt();
    const ui = UI[currentLang] || UI.de;

    // Title + Subtitle
    if (titleEl) titleEl.textContent = txt.title || "";
    if (subtitleEl) subtitleEl.textContent = txt.excerpt || ""; // du kannst hier später eigenes "lead" Feld nutzen

    // Meta
    const tags = (post.tags || []).map(t => `#${esc(t)}`).join(" ");
    if (metaEl) {
      metaEl.innerHTML = `
        <span class="blog-date">${esc(post.date || "")}</span>
        <span class="blog-tags">${tags}</span>
      `;
    }

    // SEO Title
    document.title = `${txt.title || "Blog"} – Swissploit`;

    // Video (falls vorhanden)
    const embed = post.videoUrl ? youtubeEmbed(post.videoUrl) : null;
    const videoHtml = post.videoUrl
      ? (embed
          ? `
            <div class="post-video">
              <div class="video-embed">
                <iframe
                  src="${esc(embed)}"
                  title="${esc(txt.title || "Video")}"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen></iframe>
              </div>
            </div>`
          : `<p><a class="btn small" href="${esc(post.videoUrl)}" target="_blank" rel="noopener">${esc(ui.watch)}</a></p>`
        )
      : "";

    // Content (dein content ist HTML → direkt einfügen)
    const body = txt.content || "";
    const bodyHtml = body.includes("<") ? body : `<p>${esc(body)}</p>`;

    if (contentEl) {
      contentEl.innerHTML = `
        ${videoHtml}
        <div class="post-article">
          ${bodyHtml}
        </div>
      `;
    }
  }

  // Optional: wenn du später Language Buttons auf blog-post.html einfügst
  langBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      currentLang = btn.dataset.lang || "de";
      localStorage.setItem("swissploit-blog-lang", currentLang);
      render();
    });
  });

  render();
})();
